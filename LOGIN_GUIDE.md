# 小红书登录指南

## 概述

XHS Poster 提供了智能的登录系统，支持无头模式下的二维码登录，让你可以在服务器环境中轻松完成小红书账号认证。

## 登录方式对比

### 🚀 无头模式登录（推荐）

**优势：**
- ✅ 适合服务器部署
- ✅ 终端显示二维码说明
- ✅ 自动保存二维码图片
- ✅ Cookie持久化，无需重复登录
- ✅ 完整的登录流程日志

**使用方法：**
```bash
# 启动服务器（默认无头模式）
./xhs-poster

# 或明确指定无头模式
./xhs-poster -headless=true
```

### 🖥️ 可视化浏览器登录

**优势：**
- ✅ 可视化操作界面
- ✅ 适合开发调试
- ✅ 传统扫码体验

**使用方法：**
```bash
# 启动可视化模式
./xhs-poster -headless=false
```

## 无头模式登录详细流程

### 1. 启动登录流程

通过API调用触发登录：

```bash
curl -X POST http://localhost:8080/api/v1/login
```

### 2. 系统自动处理

登录API调用后，系统会：

1. **检查已保存的cookies** - 如果有有效session，直接登录成功
2. **导航到登录页面** - 自动访问小红书登录页面
3. **查找登录按钮** - 智能识别并点击登录入口
4. **等待二维码加载** - 监测页面中的二维码元素

### 3. 二维码显示

系统找到二维码后会：

**在终端显示：**
```
========================================
           小红书登录二维码
========================================

请使用小红书手机App扫描以下二维码登录：

二维码数据URL (可在浏览器中查看): 
data:image/png;base64,iVBORw0KGgoAAAANS...

或者访问以下链接查看二维码：
data:text/html,<img src='...' style='width:300px;height:300px;'/>

登录步骤：
1. 打开小红书手机App
2. 点击右下角 '我'
3. 点击右上角扫码图标
4. 扫描上方二维码
5. 在手机上确认登录

等待扫码登录...
========================================
```

**保存二维码文件：**
- 文件名：`qrcode_login.png`
- 位置：当前工作目录
- 格式：PNG图片，可直接查看

### 4. 手机扫码

1. 打开小红书App
2. 进入"我"页面  
3. 点击右上角扫码图标📱
4. 扫描保存的二维码图片或终端显示的二维码
5. 在手机上点击"确认登录"

### 5. 登录完成

扫码成功后：
- 系统自动检测登录状态
- 保存cookies到本地文件
- 返回登录成功响应
- 后续请求自动复用登录状态

## Cookie管理

### 自动保存位置

系统会将登录cookies保存到：
1. `/tmp/cookies.json`（如果存在，向后兼容）
2. `./cookies.json`（当前目录，新版本默认）

### Cookie有效期

- cookies会在一定时间后过期
- 系统每次启动时自动尝试恢复登录状态
- 如果cookies过期，会自动触发重新登录流程

### 手动清除登录状态

```bash
# 删除保存的cookies
rm -f cookies.json qrcode_login.png

# 重新启动服务即可触发新的登录流程
```

## 故障排除

### 二维码无法显示

**问题：**无法在页面中找到二维码元素

**解决方案：**
1. 检查网络连接
2. 尝试手动访问 https://www.xiaohongshu.com/login
3. 使用非无头模式进行调试：`-headless=false`

### 登录超时

**问题：**等待5分钟后登录超时

**解决方案：**
1. 确保手机和电脑时间同步
2. 检查小红书App是否为最新版本
3. 重新生成二维码：再次调用登录API

### Cookie无效

**问题：**保存的cookies失效，需要重新登录

**解决方案：**
1. 删除 `cookies.json` 文件
2. 重新调用登录API
3. 重新扫码登录

## API 响应示例

### 登录成功

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "登录成功"
  },
  "message": "登录成功"
}
```

### 登录失败

```json
{
  "success": false,
  "error": "登录超时，请重试",
  "code": "LOGIN_FAILED"
}
```

## 最佳实践

1. **服务器部署**：使用无头模式，通过SSH查看二维码或下载图片文件
2. **开发调试**：使用可视化模式，方便观察登录流程
3. **持续集成**：定期检查cookie有效性，自动化重新登录
4. **安全考虑**：妥善保管cookies.json文件，避免泄露登录凭证

## 技术实现

系统采用以下技术确保登录的可靠性：

- **智能元素识别**：多种选择器策略查找二维码
- **截图备份**：如果无法获取二维码URL，自动截图保存
- **状态轮询**：定期检查登录状态，确保及时响应
- **超时机制**：5分钟超时保护，避免无限等待
- **错误恢复**：多种备用方案处理异常情况
